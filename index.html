<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crud Idées</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="separation">
    <div class="cont-image">
      <img src="OQK0400.jpg" alt="" class="image">
    </div>
    <div class="container">
      <form id="myForm" action="" method="POST" novalidate>
        <h1 class="titre">Ajout d'idée</h1>
        <div id="successMessage" class="alert alert-success" style="display:none;"></div>
        <div class="formul">
          <div class="form-group">
            <label for="libelle">Libelle</label>
            <input type="text" class="form-control" id="libelle" placeholder="Libelle" name="libelle">
            <div id="libelleError" class="error text-danger"></div>
          </div>

          <div class="form-group">
            <label for="categorie">Catégorie</label>
            <select class="form-control" id="categorie" name="categorie">
              <option value="">Sélectionnez une catégorie</option>
              <option value="Sport">Sport</option>
              <option value="Politique">Politique</option>
              <option value="Santé">Santé</option>
              <option value="Education">Education</option>
            </select>
            <div id="categorieError" class="error text-danger"></div>
          </div>
        </div>

        <div class="form">
          <label for="description">Description</label>
          <textarea class="form-control" id="description" aria-describedby="descriptionHelp" placeholder="Enter description" rows="4" name="description"></textarea>
          <div id="descriptionError" class="error text-danger"></div>
        </div> <br>

        <button type="submit" class="btn btn-primary" id="Insbtn">Submit</button>
      </form>
    </div>
  </div>
  <div class="col-10 mt-5 m-auto">
    <h2 class="titre">Liste des Idées</h2><br>
    <div id="ideelist" class="row">
      <!-- Les idées seront affichées ici sous forme de cartes -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script type="module">
  // Importer les fonctions nécessaires depuis les SDKs Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, set, child, get } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

// Configuration de votre application Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBvbwnzI1IvY-1UkQeK7LwxYzZRZRBEGmo",
  authDomain: "majeli-1112.firebaseapp.com",
  databaseURL: "https://majeli-1112-default-rtdb.firebaseio.com",
  projectId: "majeli-1112",
  storageBucket: "majeli-1112.appspot.com",
  messagingSenderId: "51721650054",
  appId: "1:51721650054:web:aae7b2931245368632f607"
};

// Initialiser Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Références aux éléments du DOM
const categorie = document.getElementById("categorie");
const libelle = document.getElementById("libelle");
const description = document.getElementById("description");
const form = document.getElementById("myForm");
const insbtn = document.getElementById("Insbtn");
const successMessage = document.getElementById("successMessage");
const ideelist = document.getElementById("ideelist");
const boutonSupp = document.getElementById("boutonSupp");

// Catégories autorisées
const validCategories = ["Sport", "Politique", "Santé", "Education"];

// Fonction pour afficher une alerte sous le champ concerné
function showAlert(message, element) {
  const errorElement = document.querySelector(element);
  errorElement.textContent = message;
  setTimeout(() => errorElement.textContent = "", 2000);
}

// Fonction pour afficher un message de succès
function showSuccessMessage(message) {
  successMessage.textContent = message;
  successMessage.style.display = "block";
  setTimeout(() => successMessage.style.display = "none", 3000);
}

// Fonction pour valider la longueur d'une chaîne de caractères
function validateLength(input, min, max) {
  // On trim les espaces en début et fin de chaîne de caractères
  const value = input.trim();
  // Vérifie si la longueur de la chaîne de caractères est comprise entre min et max
  return value.length >= min && value.length <= max;
}

// Fonction pour échapper les caractères spéciaux (prévention des scripts)
function escapeHTML(str) {
  // Remplace les caractères spéciaux par leurs équivalents HTML
  return str.replace(/[&<>"'\/]/g, function (s) {
    const entityMap = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#x2F;'
    };
    return entityMap[s];
  });
}

// Fonction pour insérer des données
function insert(event) {
  // Empêche l'envoi du formulaire par défaut
  event.preventDefault();

  // Échappe les valeurs des champs
  const escapedLibelle = escapeHTML(libelle.value);
  const escapedCategorie = escapeHTML(categorie.value);
  const escapedDescription = escapeHTML(description.value);

  // Validation des champs
  let isValid = true;

  // Vérifie la longueur du libellé
  if (!validateLength(escapedLibelle, 3, 40)) {
    showAlert("Le libellé doit avoir entre 3 et 40 caractères", "#libelleError");
    isValid = false;
  }

  // Vérifie la validité de la catégorie
  if (!validCategories.includes(escapedCategorie)) {
    showAlert("Catégorie invalide", "#categorieError");
    isValid = false;
  }

  // Vérifie la longueur de la description
  if (!validateLength(escapedDescription, 10, 255)) {
    showAlert("La description doit avoir entre 10 et 255 caractères", "#descriptionError");
    isValid = false;
  }

  // Si tous les champs sont valides
  if (isValid) {
    // Référence à l'emplacement de l'idée dans Firebase à partir du libellé
    const ideaRef = ref(db, "idees/" + escapedLibelle);

    // Ajoute l'idée à Firebase avec un statut initial "pending"
    set(ideaRef, {
      libelle: escapedLibelle,
      categorie: escapedCategorie,
      description: escapedDescription,
      statut: 'pending'
    })
    .then(() => {
      // Affiche un message de succès
      showSuccessMessage("L'idée a été ajoutée avec succès");
      // Réinitialise le formulaire
      form.reset();
      // Rafraîchit l'affichage des idées
      displayIdeas();
    })
    .catch((error) => {
      // Affiche une alerte en cas d'échec
      alert("Échec de l'ajout : ", error);
    });
  }
}

function displayIdeas() {
  const ideasRef = ref(db, "idees/");
  get(ideasRef)
    .then((snapshot) => {
      if (snapshot.exists()) {
        const ideas = snapshot.val();
        ideelist.innerHTML = ""; // Efface le contenu précédent

        let row = document.createElement("div");
        row.className = "row row-cols-1 row-cols-md-4 g-4";
        let count = 0;

        for (let key in ideas) {
          if (ideas.hasOwnProperty(key)) {
            const idea = ideas[key];
            let borderClass = "";
            if (idea.statut === 'approved') {
              borderClass = "border-success";
            } else if (idea.statut === 'disapproved') {
              borderClass = "border-danger";
            }
            let card = `
              <div class="col mb-4">
                <div class="card ${borderClass}">
                  <div class="card-body">
                    <h5 class="card-title">${idea.libelle}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${idea.categorie}</h6>
                    <p class="card-text">${idea.description}</p>
                    <a href="#" class="btn btn-success btn-sm approve-btn ${idea.statut === 'approved' ? 'disabled' : ''}" data-libelle="${idea.libelle}">Approuver</a>
                    <a href="#" class="btn btn-warning btn-sm disapprove-btn ${idea.statut === 'disapproved' ? 'disabled' : ''}" data-libelle="${idea.libelle}">Inapprouver</a>
                    <a href="#" class="btn btn-danger btn-sm delete-btn" data-libelle="${idea.libelle}">
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </div>
              </div>`;
            row.innerHTML += card;
            count++;
            if (count === 4) {
              ideelist.appendChild(row);
              row = document.createElement("div");
              row.className = "row row-cols-1 row-cols-md-4 g-4";
              count = 0;
            }
          }
        }
        if (count > 0) {
          ideelist.appendChild(row);
        }

        // Ajouter des écouteurs d'événements après avoir ajouté toutes les cartes
        ideelist.addEventListener('click', (event) => {
          if (event.target.classList.contains('approve-btn')) {
            const libelle = event.target.dataset.libelle;
            updateStatus(libelle, 'approved');
          }
          if (event.target.classList.contains('disapprove-btn')) {
            const libelle = event.target.dataset.libelle;
            updateStatus(libelle, 'disapproved');
          }
          if (event.target.classList.contains('delete-btn')) {
            const libelle = event.target.dataset.libelle;
            deleteIdeaFromFirebase(libelle);
          }
        });

      } else {
        ideelist.innerHTML = "<p>Aucune idée trouvée</p>";
      }
    })
    .catch((error) => {
      console.error("Erreur lors de la récupération des idées :", error);
    });
}


// Fonction pour supprimer une idée de Firebase
function deleteIdeaFromFirebase(libelle) {
  // Référence à l'idée à supprimer dans Firebase
  const ideaRef = ref(db, `idees/${libelle}`);
  // Supprime l'idée de Firebase
  set(ideaRef, null)
    .then(() => {
      // Rafraîchir l'affichage après la suppression
      displayIdeas();
    })
    .catch((error) => {
      console.error("Erreur lors de la suppression de l'idée :", error);
    });
}

// Fonction pour mettre à jour le statut dans Firebase
function updateStatus(libelle, newStatus) {
  // Référence à l'idée à mettre à jour
  const ideaRef = ref(db, `idees/${libelle}`);
  get(ideaRef)
    .then((snapshot) => {
      if (snapshot.exists()) {
        const idea = snapshot.val();
        // Mettre à jour le statut
        idea.statut = newStatus;
        set(ideaRef, idea)
          .then(() => {
            displayIdeas(); // Rafraîchir l'affichage après mise à jour
          })
          .catch((error) => {
            console.error("Erreur lors de la mise à jour de l'idée :", error);
          });
      }
    })
    .catch((error) => {
      console.error("Erreur lors de la récupération de l'idée :", error);
    });
}

// Fonction pour mettre à jour le statut de l'idée dans le localStorage
function updateIdeaStatusInLocalStorage(libelle, status) {
  let ideaStatuses = JSON.parse(localStorage.getItem("ideaStatuses")) || {};
  ideaStatuses[libelle] = status;
  localStorage.setItem("ideaStatuses", JSON.stringify(ideaStatuses));
}

// Écouteur d'événements pour le formulaire
form.addEventListener("submit", insert);

// Afficher les idées au chargement de la page
window.onload = displayIdeas;

// Approuver une idée
document.querySelector("#ideelist").addEventListener("click", (event) => {
  // Vérifie si l'élément cliqué est un bouton d'approbation
  if (event.target.classList.contains("approve-btn")) {
    // Sélectionne la carte contenant l'idée
    const card = event.target.closest(".card");
    // Récupère le libellé de l'idée à approuver
    const libelle = card.querySelector(".card-title").textContent;
    // Ajoute une bordure verte à la carte
    card.style.border = "15px solid green";
    // Désactive les boutons d'approbation et de désapprobation
    event.target.classList.add("disabled");
    card.querySelector(".disapprove-btn").classList.add("disabled");
    // Met à jour le statut de l'idée dans le localStorage
    updateIdeaStatusInLocalStorage(libelle, "approved");
    // Affiche un message de succès
    showSuccessMessage("Idée approuvée");
  }
});




  </script>
</body>

</html>
